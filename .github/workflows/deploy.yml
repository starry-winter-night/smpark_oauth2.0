name: Deploy to MacBook

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ github.ref == 'refs/heads/main' && '.env.production' || '.env.development' }} # 브랜치에 따라 구분

    env:
      ENV_NAME: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create environment file
        run: |
          cat << EOF > .env.${{ vars.NODE_ENV }}
          LOGIN_EXPIRES_IN=${{ secrets.LOGIN_EXPIRES_IN }}
          LOGIN_JWT_SECRET_KEY=${{ secrets.LOGIN_JWT_SECRET_KEY }}
          MONGO_DATABASE_NAME=${{ secrets.MONGO_DATABASE_NAME }}
          MONGO_DATABASE_PASSWORD=${{ secrets.MONGO_DATABASE_PASSWORD }}
          MONGO_DATABASE_SESSION_COLLECTION=${{ secrets.MONGO_DATABASE_SESSION_COLLECTION }}
          MONGO_DATABASE_SESSION_KEY=${{ secrets.MONGO_DATABASE_SESSION_KEY }}
          MONGO_DATABASE_URI=${{ secrets.MONGO_DATABASE_URI }}
          MONGO_DATABASE_USER=${{ secrets.MONGO_DATABASE_USER }}
          OAUTH_ACCESS_SECRET_KEY=${{ secrets.OAUTH_ACCESS_SECRET_KEY }}
          OAUTH_ACCESS_TOKEN_EXPIRES_IN=${{ secrets.OAUTH_ACCESS_TOKEN_EXPIRES_IN }}
          OAUTH_CODE_EXPIRES_IN=${{ secrets.OAUTH_CODE_EXPIRES_IN }}
          OAUTH_REFRESH_SECRET_KEY=${{ secrets.OAUTH_REFRESH_SECRET_KEY }}
          OAUTH_REFRESH_TOKEN_EXPIRES_IN=${{ secrets.OAUTH_REFRESH_TOKEN_EXPIRES_IN }}
          NODE_ENV=${{ vars.NODE_ENV }}
          OAUTH_ISSUER=${{ vars.OAUTH_ISSUER }}
          NGINX_PORT=${{ vars.NGINX_PORT }}
          APP_PORT=${{ vars.APP_PORT }}
          VERSION=${{ vars.VERSION }}
          EOF

      - name: Build, push, and deploy
        run: |
          yarn start:${{ env.ENV_NAME }}
